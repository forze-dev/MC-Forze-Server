name: Deploy Server

# –ö–æ–ª–∏ –∑–∞–ø—É—Å–∫–∞—Ç–∏ workflow
on:
  push:
    branches: [ main ] 

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è –¥–µ–ø–ª–æ—é
jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∫–æ–¥ –∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
    - name: Checkout code
      uses: actions/checkout@v4

    # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ Node.js (–¥–æ–¥–∞–≤ –¥–ª—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ)
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.19.1'
        cache: 'npm'
    
    # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
    - name: Install dependencies
      run: npm install
    
    # –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    - name: Deploy to server
      if: github.ref == 'refs/heads/main'  # —Ç—ñ–ª—å–∫–∏ –∑ main –≥—ñ–ª–∫–∏
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_KEY }}
        port: ${{ secrets.VPS_PORT }}
        script: |
          cd /var/www/api-forze-space
          echo "üìÇ Pulling latest changes..."
          git pull origin main
          echo "üì¶ Installing dependencies..."
          npm install --production
          echo "üîÑ Restarting server..."
          pm2 restart 1
          echo "‚úÖ Bot restarted successfully!"
          pm2 status

    # –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ —É—Å–ø—ñ—à–Ω–∏–π –¥–µ–ø–ª–æ–π
    - name: Notify success
      if: success()
      run: echo "‚úÖ Server deployed successfully!"
    
    - name: Notify failure
      if: failure()
      run: echo "‚ùå Server deployment failed!"